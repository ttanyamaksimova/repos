---
title: "Практическая работа 6"
author: "tanya.maksimova.2004@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Название

Исследование вредоносной активности в домене Windows

## Цель работы

1. Закрепить навыки исследования данных журнала Windows Active Directory

2. Изучить структуру журнала системы Windows Active Directory

3. Закрепить практические навыки использования языка программирования R для обработки данных

4. Закрепить знания основных функций обработки данных экосистемы tidyverse языка R

## Исходные данные

1.  Ноутбук с ОС Windows 10
2.  Rstudio Desktop
3.  Интерпретатор R 4.5.1

```{R}
sessionInfo()
```

## Задание

Используя программный пакет dplyr, освоить анализ DNS логов с помощью языка программирования R.

## Ход работы

1. Подготовить данные
2. Провести анализ

## Выполнение шагов

### Шаг 1

Установим и подключим необходимые пакеты:

Подключим необходимые библиотеки:

```{r}
library(dplyr)
```

```{r}
library(tidyverse)
```

```{r}
library(jsonlite)
```

Подготовим данные:

#### 1. Импортируем данные в R:

```{r}
untar("dataset.tar.gz", exdir = ".")
data <-jsonlite::stream_in(file("caldera_attack_evals_round1_day1_2019-10-20201108.json"), verbose = FALSE)
```

#### 2. Приведём датасет в вид “аккуратных данных”, преобразуем типы столбцов в соответствии с типом данных:

```{r}
data <- data %>% rename(metadata = `@metadata`, timestamp = `@timestamp`)
```

#### 3. Посмотрим общую структуру данных:

```{r}
glimpse(data)
```

### Шаг 2

Анализ:

#### 1. Раскройте датафрейм избавившись от вложенных датафреймов.

```{r}
data <- unnest(data, cols = c(metadata, event, log, winlog, ecs, host, agent), 
                      names_sep = "_")
glimpse(data)
```

#### 2. Минимизируйте количество колонок в датафрейме – уберите колоки с единственным значением параметра.

```{r}
data <- data %>% select(where(~n_distinct(., na.rm = TRUE) > 1))

glimpse(data)
```

#### 3. Какое количество хостов представлено в данном датасете?

```{r}
 data %>% pull(winlog_computer_name) %>% na.omit() %>% unique() %>% length()
```

#### 4. Подготовьте датафрейм с расшифровкой Windows Event_ID, приведите типы данных к типу их значений

```{r}
library(xml2)
library(rvest)
```

```{r}
webpage_url <- "https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor"
webpage <- xml2::read_html(webpage_url)
event_df <- rvest::html_table(webpage)[[1]]
```

```{r}
event_df <- event_df %>%
  rename(Current_Windows_Event_ID = `Current Windows Event ID`,
    Legacy_Windows_Event_ID = `Legacy Windows Event ID`,
    Potential_Criticality = `Potential Criticality`,
    Event_Summary = `Event Summary`) %>%
  mutate (Current_Windows_Event_ID = as.integer(Current_Windows_Event_ID),
    Legacy_Windows_Event_ID = as.integer(Legacy_Windows_Event_ID))
```

```{r}
glimpse(event_df)
```

#### 5. Есть ли в логе события с высоким и средним уровнем значимости? Сколько их?

```{r}
res <- data %>%
  left_join(event_df %>% select(Current_Windows_Event_ID, Potential_Criticality),
            by = c("winlog_event_id" = "Current_Windows_Event_ID")) %>%
  filter(Potential_Criticality == "High" | Potential_Criticality == "Medium") %>%
  count(Potential_Criticality, .drop = FALSE)

cat("Количество с высоким или средним уровнем значимости: ", sum(res$n))
```
## Вывод

В ходе выполнения 6 практической работы были получены получены навыки исследования данных журнала Windows Active Directory.