---
title: "Практическая работа 5"
author: "tanya.maksimova.2004@yandex.ru"
format: 
  md:
    output-file: README.md
---

## Название

Исследование информации о состоянии беспроводных сетей

## Цель работы

1. Получить знания о методах исследования радиоэлектронной обстановки

2. Составить представление о механизмах работы Wi-Fi сетей на канальном и сетевом уровне модели OSI

3. Закрепить практические навыки использования языка программирования R для обработки данных

4. Закрепить знания основных функций обработки данных экосистемы tidyverse языка R


## Исходные данные

1.  Ноутбук с ОС Windows 10
2.  Rstudio Desktop
3.  Интерпретатор R 4.5.1

```{R}
sessionInfo()
```

## Задание

Используя программный пакет dplyr языка программирования R провести анализ журналов и ответить на вопросы

## Ход работы

1. Подготовить данные

2. Провести анализ точек доступа

3. Провести анализ данных клиентов

## Выполнение шагов

### Шаг 1

Установим и подключим необходимые пакеты:

```{r}
library(dplyr)
```

```{r}
library(readr)
```

```{r}
library(tidyverse)
```

#### 1. Импортируйте данные

```{r}
td_data <- read_csv("P2_wifi_data.csv", skip = 1, n_max = 167)

client_data <- read_csv("P2_wifi_data.csv", skip = 169)
```

#### 2. Привести датасеты в вид “аккуратных данных”, преобразовать типы столбцов в соответствии с типом данных

```{r}
td_data <- td_data %>% 
    rename(
    first_seen = `First time seen`,
    last_seen = `Last time seen`,
    speed = Speed,
    privacy = Privacy,
    cipher = Cipher,
    auth = Authentication,
    power = Power,
    beacons = `# beacons`,
    iv = `# IV`,
    lan_ip = `LAN IP`,
    id_length = `ID-length`,
    essid = ESSID,
    key = Key
  ) %>% 
  mutate(
    first_seen = as_datetime(first_seen),
    last_seen = as_datetime(last_seen),
    channel = as.integer(channel),
    speed = as.integer(speed),
    power = as.integer(power),
    beacons = as.integer(beacons),
    iv = as.integer(iv),
    id_length = as.integer(id_length))
```

```{r}
client_data <- client_data %>%
    rename(
    station_mac = `Station MAC`,
    first_seen = `First time seen`,
    last_seen = `Last time seen`,
    power = Power,
    packets = `# packets`,
    probed_ESSIDs = `Probed ESSIDs`
  ) %>%
  mutate(
    first_seen = as_datetime(first_seen),
    last_seen = as_datetime(last_seen),
    power = as.integer(power),
    packets = as.integer(packets))
```

#### 3. Просмотрите общую структуру данных с помощью функции glimpse()

```{r}
glimpse(td_data)
```

```{r}
glimpse(client_data)
```
### Шаг 2

Анализ точек доступа:

#### 1. Определить небезопасные точки доступа (без шифрования – OPN)

```{r}
unsave_td <- td_data %>% filter(privacy == "OPN") %>% select(BSSID)
unsave_td
```

#### 2. Определить производителя для каждого обнаруженного устройства

```{r}
oui_db <- read.csv("oui.csv")

get_manufacturer <- function(mac) {
  oui <- gsub(":", "", substr(mac, 1, 8))
  result <- oui_db[oui_db$Assignment == oui, ]
  
  if(nrow(result) > 0) {
    return(result$Organization.Name[1])
  } else {
    return(NA)
  }
}

unsave_td <- unsave_td %>% mutate(manufacturer = sapply(BSSID, get_manufacturer))

unsave_td %>% select(BSSID, manufacturer) %>% print(n = Inf)
```


#### 3. Выявить устройства, использующие последнюю версию протокола шифрования WPA3, и названия точек доступа, реализованных на этих устройствах

```{r}
td_data %>% filter(str_detect(privacy, "WPA3")) %>% select(BSSID, essid, privacy)
```

#### 4. Отсортировать точки доступа по интервалу времени, в течение которого они находились на связи, по убыванию.

```{r}
td_sessions <- td_data %>%
  arrange(BSSID, first_seen) %>%
  group_by(BSSID) %>%
  mutate(gap = as.numeric(difftime(first_seen, lag(last_seen, default = first(first_seen)))), sess_id = cumsum(gap > 2700) + 1) %>%
  group_by(BSSID, sess_id) %>%
  summarise(start = min(first_seen), end = max(last_seen), .groups = 'drop') %>%
  group_by(BSSID) %>%
  mutate(sessions = n()) %>%
  ungroup() %>%
  mutate(duration = as.numeric(end - start, units = "secs")) %>%
  arrange(desc(duration)) %>%
  select(BSSID, sessions, start, end, duration)
td_sessions
```

#### 5. Обнаружить топ-10 самых быстрых точек доступа.

```{r}
td_data %>% arrange(desc(speed)) %>% select(BSSID, speed) %>% head(10)
```

#### 6. Отсортировать точки доступа по частоте отправки запросов (beacons) в единицу времени по их убыванию

```{r}
td_beac <- td_data %>%
  mutate(duration = as.numeric(last_seen - first_seen, units = "secs"), 
         bps = ifelse(duration != 0, beacons / duration, NA)) %>%
  arrange(desc(bps))  %>%
  select(BSSID, essid, first_seen, last_seen, beacons, duration, bps)

td_beac
```

### Шаг 3

Анализ данных клиентов:

#### 1. Определить производителя для каждого обнаруженного устройства

```{r}
client_data <- client_data %>%
  mutate(manufacturer = sapply(station_mac, get_manufacturer))
client_data %>% select(station_mac, manufacturer) %>% head(10)
```

#### 2. Обнаружить устройства, которые НЕ рандомизируют свой MAC адрес

```{r}
client_data %>% filter(!substr(station_mac, 2, 2) %in% c("2", "6", "a", "A", "e", "E")) %>% distinct() %>% select(station_mac)
```

#### 3. Кластеризовать запросы от устройств к точкам доступа по их именам. Определить время появления устройства в зоне радиовидимости и время выхода его из нее.

```{r}
clusters <- client_data %>%
  filter(!is.na(probed_ESSIDs) & probed_ESSIDs != "") %>%
  mutate(networks = strsplit(probed_ESSIDs, ",")) %>%
  unnest(networks) %>%
  mutate(networks = trimws(networks)) %>%
  group_by(station_mac, networks) %>%
  summarise(first = min(first_seen), last = max(last_seen), .groups = "drop") %>%
  mutate(duration = as.numeric(last - first, units = "secs")) %>%
  arrange(station_mac, first)

clusters
```

#### 4. Оценить стабильность уровня сигнала внури кластера во времени. Выявить наиболее стабильный кластер.

```{r}
clusters %>% inner_join(client_data, by = "station_mac") %>%
filter(first_seen >= first & last_seen <= last) %>% group_by(networks) %>%
summarise(n_requests = n(), mean_power = mean(power, na.rm = TRUE),
sd_power = if(n() == 1) 0 else sd(power, na.rm = TRUE), .groups = "drop") %>%
filter(n_requests >= 5) %>% arrange(sd_power) %>% head(1)

```

## Вывод

В ходе выполнения 5 практической работы были получены знания о методах исследования радиоэлектронной обстановки с помощью журналов программных средств анализа беспроводных сетей.

